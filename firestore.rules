rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Función auxiliar: verificar si el usuario está autenticado
    function isAuthenticated() {
      return request.auth != null;
    }

    // Función auxiliar: verificar si el usuario es el dueño del documento
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Función auxiliar: verificar si el usuario es admin
    function isAdmin() {
      return isAuthenticated() &&
             get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.exists == true;
    }

    // ============================================
    // COLECCIÓN: vendedores
    // ============================================
    match /vendedores/{vendedorId} {
      // Permitir lectura pública: todos pueden ver información de vendedores (para menú público)
      allow read: if true;

      // Permitir escritura: solo el propio vendedor o admin
      allow create: if isOwner(vendedorId);
      allow update: if isOwner(vendedorId) || isAdmin();
      allow delete: if isAdmin();
    }

    // ============================================
    // COLECCIÓN: estudiantes
    // ============================================
    match /estudiantes/{estudianteId} {
      // Permitir lectura: el propio estudiante, usuarios autenticados (para que vendedores vean info de clientes), o admin
      allow read: if isOwner(estudianteId) || isAuthenticated() || isAdmin();

      // Permitir escritura: solo el propio estudiante o admin
      allow create: if isOwner(estudianteId);
      allow update: if isOwner(estudianteId) || isAdmin();
      allow delete: if isAdmin();
    }

    // ============================================
    // COLECCIÓN: platillos
    // ============================================
    match /platillos/{platilloId} {
      // Permitir lectura pública: todos pueden ver los platillos disponibles (sin autenticación)
      allow read: if true;

      // Permitir escritura: solo el vendedor propietario o admin
      allow create: if isAuthenticated() &&
                       request.resource.data.vendedorId == request.auth.uid;
      
      // Permitir actualizar: vendedor propietario, admin, o cualquier usuario autenticado 
      // que solo modifique cantidadDisponible (para reducir inventario al crear pedidos)
      allow update: if isAuthenticated() && (
                       resource.data.vendedorId == request.auth.uid || 
                       isAdmin() ||
                       // Permitir a cualquier usuario autenticado reducir inventario
                       (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['cantidadDisponible']) &&
                        request.resource.data.cantidadDisponible < resource.data.cantidadDisponible)
                     );
      
      allow delete: if isAuthenticated() &&
                       (resource.data.vendedorId == request.auth.uid || isAdmin());
    }

    // ============================================
    // COLECCIÓN: pedidos
    // ============================================
    match /pedidos/{pedidoId} {
      // Permitir lectura: solo el estudiante o vendedor involucrado, o admin
      allow read: if isAuthenticated() &&
                     (resource.data.estudianteId == request.auth.uid ||
                      resource.data.vendedorId == request.auth.uid ||
                      isAdmin());

      // Permitir crear: cualquier estudiante autenticado
      allow create: if isAuthenticated() &&
                       request.resource.data.estudianteId == request.auth.uid;

      // Permitir actualizar: solo el vendedor del pedido o admin
      allow update: if isAuthenticated() &&
                       (resource.data.vendedorId == request.auth.uid || isAdmin());

      // Permitir eliminar: solo admin
      allow delete: if isAdmin();
    }

    // ============================================
    // COLECCIÓN: calificaciones
    // ============================================
    match /calificaciones/{calificacionId} {
      // Permitir lectura pública: todos pueden ver las calificaciones (para menú público)
      allow read: if true;

      // Permitir crear: cualquier estudiante autenticado
      allow create: if isAuthenticated() &&
                       request.resource.data.estudianteId == request.auth.uid;

      // Permitir actualizar: solo el estudiante que creó la calificación o admin
      allow update: if isAuthenticated() &&
                       (resource.data.estudianteId == request.auth.uid || isAdmin());

      // Permitir eliminar: solo el estudiante que creó la calificación o admin
      allow delete: if isAuthenticated() &&
                       (resource.data.estudianteId == request.auth.uid || isAdmin());
    }

    // ============================================
    // COLECCIÓN: reportes
    // ============================================
    match /reportes/{reporteId} {
      // Permitir lectura: solo admin
      allow read: if isAdmin();

      // Permitir crear: cualquier usuario autenticado
      allow create: if isAuthenticated();

      // Permitir actualizar: solo admin
      allow update: if isAdmin();

      // Permitir eliminar: solo admin
      allow delete: if isAdmin();
    }

    // ============================================
    // COLECCIÓN: mensajes_contacto
    // ============================================
    match /mensajes_contacto/{mensajeId} {
      // Permitir lectura: solo admin
      allow read: if isAdmin();

      // Permitir crear: cualquier usuario puede enviar mensajes
      allow create: if true; // Permitir incluso sin autenticación para contactos públicos

      // No permitir actualizar ni eliminar (solo admin puede hacerlo manualmente)
      allow update, delete: if isAdmin();
    }

    // ============================================
    // COLECCIÓN: conversaciones
    // ============================================
    match /conversaciones/{conversacionId} {
      // Permitir lectura: solo estudiante o vendedor involucrado, o admin
      allow read: if isAuthenticated() &&
                     (resource.data.estudianteId == request.auth.uid ||
                      resource.data.vendedorId == request.auth.uid ||
                      isAdmin());

      // Permitir crear: solo estudiante o vendedor autenticado
      allow create: if isAuthenticated() &&
                       (request.resource.data.estudianteId == request.auth.uid ||
                        request.resource.data.vendedorId == request.auth.uid);

      // Permitir actualizar: solo estudiante o vendedor involucrado
      allow update: if isAuthenticated() &&
                       (resource.data.estudianteId == request.auth.uid ||
                        resource.data.vendedorId == request.auth.uid ||
                        isAdmin());

      // Permitir eliminar: solo admin
      allow delete: if isAdmin();
    }

    // ============================================
    // COLECCIÓN: mensajes
    // ============================================
    match /mensajes/{mensajeId} {
      // Función auxiliar: verificar si el usuario está en la conversación
      function isInConversacion(conversacionId) {
        let conversacion = get(/databases/$(database)/documents/conversaciones/$(conversacionId)).data;
        return conversacion.estudianteId == request.auth.uid ||
               conversacion.vendedorId == request.auth.uid;
      }

      // Permitir lectura: solo si está en la conversación
      allow read: if isAuthenticated() &&
                     isInConversacion(resource.data.conversacionId);

      // Permitir crear: solo si está en la conversación y es el remitente
      allow create: if isAuthenticated() &&
                       request.resource.data.remitenteId == request.auth.uid &&
                       isInConversacion(request.resource.data.conversacionId);

      // No permitir actualizar ni eliminar mensajes (inmutables)
      allow update, delete: if isAdmin();
    }

    // ============================================
    // COLECCIÓN: promociones
    // ============================================
    match /promociones/{promocionId} {
      // Permitir lectura pública: todos pueden ver las promociones activas
      allow read: if true;

      // Permitir escritura: solo admin
      allow create, update, delete: if isAdmin();
    }

    // ============================================
    // COLECCIÓN: usos_promociones
    // ============================================
    match /usos_promociones/{usoId} {
      // Permitir lectura: el propio estudiante o admin
      allow read: if isAuthenticated() &&
                     (resource.data.estudianteId == request.auth.uid || isAdmin());

      // Permitir crear: cualquier estudiante autenticado
      allow create: if isAuthenticated() &&
                       request.resource.data.estudianteId == request.auth.uid;

      // No permitir actualizar ni eliminar
      allow update, delete: if isAdmin();
    }

    // ============================================
    // COLECCIÓN: admins (solo lectura por admin)
    // ============================================
    match /admins/{adminId} {
      allow read, write: if isAdmin();
    }
  }
}

